## 密语5.0消息服务

### 连接

* 通过websocket方式连接，tansports仅为websocket
* 连接extraHeaders参数如下：

```
{
  "uid": "用户id",
  "token": "用户token",
  "deviceid": "设备号",
  "platform": "设备平台，可选值：iPhone/iPad/AnPhone(安卓手机)/AnPad(安卓pad)/PC(电脑)/Web(网站)"
}
```

* server会用以上header中的参数做用户鉴权，鉴权成功才可连接


### 客户端消息发送流程
* 客户端按照以上消息结构组装消息
* 将消息用 [messagepack](http://msgpack.org/) 格式编码成16进制HexString
* 将编码后的HexString采用aes-256-cbc的方式进行加密（密钥暂时用 md5(用户id:token:设备id)，后续变动再定），加密结果转成16进制HexString
* 将最终的加密数据通过socket发送给服务器
* 服务器返回本次发送的ack信息

### 客户端消息接收流程
* 服务器通过socket发送加密后的数据到客户端
* 客户端用aes-256-cbc的方式进行解密
* 解密的数据用 [messagepack](http://msgpack.org/) 进行解码
* 拿到解码后的数据并返回给服务器ack


### socket事件
* **kickout** (客户端监听)：用户被T出事件
* **realtime_msg** (客户端监听)：实时消息事件，通过此事件接受新消息
* **cs_broadcast_reload** (客户端监听)：刷新客服团队广播消息事件，接收到此事件立即获取新的广播消息
* **send_msg** (客户端发送)：发送消息事件
* **offline_msg** (客户端发送)：获取离线消息，如果有字段 `lastEvaluatedKey`，说明还有更多的离线消息，需要继续拉取；如果没有字段 `lastEvaluatedKey`，需要给服务器发送 **offline_msg_ack**，参数为当前拉取消息Id（逗号拼接）
* **offline_msg_ack** (客户端发送)：客户端提交离线消息获取回执
* **msg_read** (客户端发送)：客户端发送消息已读回执，客户端需要提交数据格式如下(提交成功ack为1，失败ack为0)

```
//单条消息已读
{
   "sign_type": 0,   //标记的类型
   "target_uid": "123456",  //标记的目标用户的id
   "uid": "234567",    //自己的用户id
   "sign_msgId": "xxxx-xxxx-xxxx-xxxx-xxxx"  //标记的目标消息的id
}

//批量消息已读
{
   "sign_type": 1,   //标记的类型
   "target_uid": "123456",  //标记的目标用户的id
   "uid": "234567",    //自己的用户id
   "sign_time": 1491981191383  //标记的时间戳(将对方发送的这个时间之前的消息全部标记)
}
```

* **recall_msg** (客户端发送)：客户端撤回消息，客户端需要提交数据格式如下(提交成功ack为1，失败ack为0)

```
{
   "msgId": "xxxx-xxxx-xxxx-xxxx-xxxx", //撤回的消息id
   "uid": "123456",   //当前用户的id
   "target_uid": "456789",    //撤回的聊天对象的id
   "c_type": 100       //撤回的聊天类型，按照消息体的聊天类型（int）
}

// 接收方收到的消息体中body如下
{
   "type": "recallMsg",
   "msgId": "撤回的消息id",
   "uid": "撤回方的用户id",
   "c_type": 100,   //撤回的聊天类型，按照消息体的聊天类型（int）
   "groupMark": "撤回方的名称，优先使用群昵称，未设置使用用户昵称（只在类型为群组和二度人脉的时候有这个字段）"
}
```

* **cs_broadcast_msg** (客户端发送)：获取新的广播消息的事件
* **update_broadcast_version** (客户端发送)：更新广播消息版本号事件，参数为版本号（版本号即为此次获取消息的最后一条消息的publishTimestamp，Number类型），更新成功ack为1，失败ack为0


### socket连接错误状态码
```
{
    "METALK_INVALID_CONN_ERROR": "无效的连接，产生原因：header里的参数缺失",
    "METALK_CHECK_TOKEN_ERROR": "检查token错误，产生原因：数据库错误",
    "METALK_INVALID_TOKEN_ERROR": "无效的token，产生原因：token错误或失效，客户端需提示并退出到登录界面",
    "METALK_CHECK_USER_STATUS_ERROR": "检查用户状态，产生原因：数据库错误",
    "METALK_INVALID_USER_STATUS_ERROR": "用户状态非法，产生原因：用户未处于正常登录状态，客户端需提示并退出到登录界面",
    "METALK_KICK_OUT_ERROR": "此设备上的用户被T出，产生原因：用户在其他设备登录，客户端需提示并退出到登录界面"
}
```


### 消息基础结构

```
{
	"s_uid": "发送人id",
	"r_uid": "接收人id",
	"con_id": "会话id（聊天对象的id）",
	"body": "消息内容(结构不固定)", 
	"s_msgId": "服务器消息id(客户端提交的时候不用传，由服务器返回)",
	"c_msgId": "客户端消息id",
	"c_type": "聊天类型（群聊、单人聊天）",
	"m_type": "消息类型",
	"s_time": "发送时间戳(客户端提交的时候不用传，由服务器返回)"	
}
```

### 消息类型(类型为Int)
```
{
	// 普通消息类型
	200: 文本消息,
	201: 图片消息,
	202: 语音消息,
	203: 视频消息,
	204: 地理位置,
	205: 名片,
	206: 事件消息,
	207: 系统消息,
	208: 分享消息,
	209: 大表情,
	210: 文件消息,
	211: 系统提醒类消息,
	
	// 阅后即焚消息类型
	300: 文本消息,
	301: 图片消息,
	302: 语音消息,
	303: 视频消息
}
```

### 聊天类型(类型为Int)
```
{
	100: 个人聊天,
	101: 群组聊天,
	102: 二度人脉聊天,
	103: 客服团队,
	104: 任务助手
}
```

### 消息示例

* 文本消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"content": "Hello, Metalk!"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 200,
	"s_time": 1487325174805	
}
```

* 图片消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"url": "https://xxxxxxxxxxxx",
		"width": 100,
		"height": 100
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 201,
	"s_time": 1487325174805	
}
```

* 语音消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"url": "https://xxxxxxxxxxxx",
		"duration": 20
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 202,
	"s_time": 1487325174805	
}
```

* 视频消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"url": "https://xxxxxxxxxxxx",
		"cover_url": "https://xxxxxxxxxxxx"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 203,
	"s_time": 1487325174805	
}
```

* 地理位置消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"url": "https://xxxxxxxxxxxx",
		"lat": "100.828282",
		"lon": "100.282828",
		"title": "北京市朝阳区xxxxxxxxxx"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 204,
	"s_time": 1487325174805	
}
```

* 名片消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"icon": "https://xxxxxxxxx", 头像
		"nickname": "xxxx", 昵称
		"userId": "111111", 用户id
		"vipCode": "123" 靓号,
		"iconVideo": "头像视频地址",
		"duty": "职位",
		"location": "位置",
		"locationFrom": "来自",
		"workExperience": "工作经验",
		"education": "教育背景"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 205,
	"s_time": 1487325174805	
}
```

* 事件消息示例

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"title": "事件标题",
		"address": "地址",
		"time": "时间",
		"type": "时间消息类型",
		"eventId": "事件id",
		"userId" : "发起者Id",
		"icon" : "发起人头像",
		"title" : "事件标题",
		"nickName" : "发起人昵称"
		"duty" : "发起人职位",
		"address" : "事件地址",
		"startTime" : "开始事件",
		"type" : "时间类型，0:新事件，1:编辑事件，2:事件提醒，3:事件删除"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 206,
	"s_time": 1487325174805	
}
```


* 大表情

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"content_ch": "表情中文描述",
		"content_en": "表情英文描述",
		"url": "表情地址",
		"packageId": "表情包id"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 206,
	"s_time": 1487325174805	
}
```

* 收藏

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"id": "收藏id（探索id或者动态id）",
		"url": "封面图",
		"title": "标题",
		"type": "类型"，1：探索 0: 动态,
		"from" : 来自,
		"content" : 内容，探索 webUrl,
		"userId" : 发送者的用户 id
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 206,
	"s_time": 1487325174805	
}
```

* 文件

```
{
	"s_uid": "123456",
	"r_uid": "456789",
	"con_id": "456789",
	"body": {
		"fileName": "文件名",
		"fileUrl": "文件下载路径",
		"fileMd5": "文件md5",
		"fileSize": "文件大小"
	},
	"s_msgId": "100000",
	"c_msgId": "100000",
	"c_type": 100,
	"m_type": 206,
	"s_time": 1487325174805	
}
```